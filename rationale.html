<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>tts: Rationale</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="godbolt.js"></script>
<script type="text/javascript" src="fragment.js"></script>
<script type="text/javascript" src="paragraph.js"></script>
<script type="text/javascript">
  DoxygenAwesomeParagraphLink.init()
  DoxygenAwesomeFragmentCopyButton.init()
  SendToGodbolt.init("tts","clang1600","-O3 -std=c++20 -DNEDBUG")
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="color.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<a href="https://github.com/jfalcou/tts" class="github-corner" title="View source on GitHub" target="_blank">
    <svg viewBox="0 0 250 250" width="40" height="40" style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- BEGIN TITLEAREA-->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr  style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">tts<span id="projectnumber">&#160;v2.3.0</span>
   </div>
   <div id="projectbrief">The Tiny Test System</div>
  </td>
 </tr>
   <tr><td colspan="2" style="padding: 20px 0px 0px 0px;">        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td></tr>
 </tbody>
</table>
</div>
<!--END TITLEAREA -->
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('rationale.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Rationale</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#ulp">Precision testing</a><ul><li class="level2"><a href="#ulp-metric">Precision metric</a></li>
<li class="level2"><a href="#ulp-computing">Computing ULP</a></li>
</ul>
</li>
<li class="level1"><a href="#ulp-testing">Testing ULPs</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="ulp"></a>
Precision testing</h1>
<blockquote class="doxtable">
<p>&zwj;Are these two floating computations results similar enough? </p>
</blockquote>
<p>This is maybe the most difficult question to answer when implementing and validating numerical algorithms. Various methods are often found in existing testing frameworks or are used by developers. But if floating-point arithmetic can be tricky, floating-point comparisons are even trickier.</p>
<p>In the rest of this section, we take for granted that the basic notions of floating-point computations and their related problems are known by the reader. If not, we strongly recommend having a deep look at <a href="http://docs.oracle.com/cd/E19957-01/806-3568/ncg_goldberg.html">Goldberg's paper on the subject</a> or a <a href="http://floating-point-gui.de/">simplified version</a>.</p>
<h2><a class="anchor" id="ulp-metric"></a>
Precision metric</h2>
<p>The first thing people learn (and often they learn it the hard way) is that strict equality for floating points numbers is often meaningless or very hard to achieve. Once this state of fact is integrated, people often go to use a simple absolute difference with an arbitrary threshold. If this method looks sound, it's easy to fold and may lead to false positives. The proper way to compare non-zero or non-invalid floating-point numbers is to use the <b>Unit in the Last Place</b> metric.</p>
<p>Let us define ε &ndash; the machine epsilon &ndash; as being the smallest positive floating-point number such that 1+ε is different from 1. Usually, ε is equal to \(2^-52\) for double precision numbers and \(2^-23\) for single precision numbers. In fact, 1+ε and 1 only differ by one bit in the least significant digit: the unit in the last place (ULP). For IEEE754 numbers, the ULP between a floating-point number \(x\) and its immediate successor is \(2^E \times \epsilon\) where E is the exponent of x.</p>
<h2><a class="anchor" id="ulp-computing"></a>
Computing ULP</h2>
<p>The ULP distance (or <code>ulpdist</code>) is a way to compare floating-point numbers by estimating the number of significant bits between their respective representations. The IEEE 754 specification &ndash; followed by most modern floating-point hardware &ndash; requires that the result of an elementary arithmetic operation (addition, subtraction, multiplication, division, and square root) must be within 0.5 ULP of the mathematically exact result. Achieving 0.5-1 ULP for computationally complex functions like transcendental functions is what a proper numerical library should aim for.</p>
<p>The full algorithm can be expressed in standard C++ in the following way:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt; <span class="keywordtype">double</span> ulpdist(T a0, T a1)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// Exit if a0 and a1 are equal or both NaN</span></div>
<div class="line">  <span class="keywordflow">if</span>( (a0 == a1) || ((a0!=a0) &amp;&amp; (a1!=a1)) )</div>
<div class="line">    <span class="keywordflow">return</span> 0.;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">int</span> e1,e2;</div>
<div class="line">  T   m1,m2;</div>
<div class="line">  m1 = std::frexp(a0, &amp;e1);</div>
<div class="line">  m2 = std::frexp(a1, &amp;e2);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Compute the largest exponent between arguments</span></div>
<div class="line">  <span class="keywordtype">int</span> expo = std::max(e1, e2);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Properly normalize the two numbers by the same factor in a way</span></div>
<div class="line">  <span class="comment">// that the largest of the two numbers exponents will be brought to zero</span></div>
<div class="line">  T n1 = std::ldexp(a0, -expo);</div>
<div class="line">  T n2 = std::ldexp(a1, -expo);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Compute the absolute difference of the normalized numbers</span></div>
<div class="line">  T e = (e1 == e2) ? std::abs(m1-m2) : std::abs(n1-n2);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Return the distance in ULP by diving this difference by the machine epsilon</span></div>
<div class="line">  <span class="keywordflow">return</span> double(e/std::numeric_limits&lt;T&gt;::epsilon());</div>
<div class="line">}</div>
</div><!-- fragment --><p>Put in another way, one can estimate the <code>ulpdist</code> between two floating point numbers as the number of representable floating points values between them. This estimation leads to the following properties:</p>
<p>\(
\begin{align}
ulpdist(N,N \times ε) &amp; = 0.5 \\
ulpdist(N,N+N \times \frac{ε}{2}) &amp; = 0 \\
\end{align}
\)</p>
<p>Note that if a <code>double</code> is compared to the double representation of its single precision conversion (they are exceptions as for fully representable reals), their <code>ulpdist</code> will be around \(2^{26.5}\) (or \(10^8\)). For example: <code>ulpdist( double(float(M_PI)), double(M_PI) ) == 9.84293e+07</code></p>
<h1><a class="anchor" id="ulp-testing"></a>
Testing ULPs</h1>
<p>What to do then when writing an unit test that handles floating points number ? You basically have three cases : </p><pre class="fragment">The value you compare must be equal by design. In this case, use [**`TTS_EQUAL`**](reference.html#tts_equal)
to clearly state your intent. One such case can be for example functions that construct a floating point value bitwise.
The value you compare are the results of an undetermined number of other
floating point operations. In this case, use [**`TTS_ULP_EQUAL`**](reference.html#tts_ulp_equal)
and try to estimate the maximum amount of ULP your implementation should give. This can be either
done by a strict analysis of the function behavior or by some guess work.
The value you compare are the results of an undetermined number of other floating point operations
but stands in a predictable absolute range of error independent of the architecture and magnitude
of the input. In this case, use [**`TTS_RELATIVE_EQUAL`**](reference.html#tts_relative_equal).
</pre><p> Take extreme care to not overestimate the value of ULP measures. Some classical algorithms may ends up with hundreds of ULPs but still be meaningful. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.20-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
  </ul>
</div>
</div> <!-- DOXYSTRAP RELATED -->
</div> <!-- DOXYSTRAP RELATED -->
</div> <!-- DOXYSTRAP RELATED -->
</div> <!-- DOXYSTRAP RELATED -->
</div> <!-- DOXYSTRAP RELATED -->
</body>
</html>
